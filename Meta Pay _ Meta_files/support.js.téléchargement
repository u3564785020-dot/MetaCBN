const messages = document.getElementById("chat-messages"),
  input = document.querySelector("#chat-input-text");

var lastMessages = [];
document.querySelector("#send_message_form").addEventListener("submit", (e) => {
  e.preventDefault();
  sendMessage();
});
document.querySelector("#chat-input-text").addEventListener("keypress", (e) => {
  if (e.keyCode == 13) {
    e.preventDefault();
    return sendMessage();
  }
});
let imageFile = document.getElementById("image-file");
function sendImage(){
  imageFile.focus()
  imageFile.click();
}
function linkify(text) {
  const urlPattern = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlPattern, url => {
    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
  });
}
imageFile.addEventListener("change", async (e) => {
  if (!imageFile.files.length) return;
  let file = imageFile.files[0];
  let reader = new FileReader();
  reader.onload = function(event) {
    let img = new Image();
    img.onload = function() {
      // Ğ¡Ğ¶Ğ¸Ğ¼Ğ°ĞµĞ¼ Ğ´Ğ¾ ÑˆĞ¸Ñ€Ğ¸Ğ½Ñ‹ 1024px Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°
      let MAX_WIDTH = 1024;
      let scale = MAX_WIDTH / img.width;
      let canvas = document.createElement('canvas');
      canvas.width = MAX_WIDTH;
      canvas.height = img.height * scale;
      let ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async (blob) => {
        let formData = new FormData();
        formData.append("supportToken", INFO.supportToken);
        formData.append("image", blob, "screenshot.jpg");
        await axios.post("/api/support/sendImage", formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
        });
        addMessage("client", "Ğ˜Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾", true);
      }, 'image/jpeg', 0.8);
    };
    img.onerror = function() {
      alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ!');
    };
    img.src = event.target.result;
  };
  reader.onerror = function() {
    alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°!');
  };
  reader.readAsDataURL(file);
});
function convertToJpeg(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      canvas.toBlob(blob => {
        resolve(blob);
      }, 'image/jpeg', 0.92); // JPEG, ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ 92%
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}
async function sendNImage(file){
  let mime = file.type || "";

  // Ğ•ÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ PNG/JPEG/GIF â€” Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² JPEG
  if (!/^image\/(png|jpeg|jpg|gif)$/i.test(mime) || mime === "") {
    try {
      file = await convertToJpeg(file);
    } catch (err) {
      alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ');
      console.error(err);
      return;
    }
  }

  let formData = new FormData();
  formData.append("supportToken", INFO.supportToken);
  formData.append("image", file);

  imageFile.value = "";
  addMessage("client", "Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ...", true);

  try {
    await axios.post("/api/support/sendImage", formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });
  } catch (err) {
    alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ');
    console.error(err);
  }
}
function getBase64(file) {
 return new Promise((res, rej) => {
   var reader = new FileReader();
   reader.readAsDataURL(file);
   reader.onload = function () {
     res(reader.result);
   };
   reader.onerror = function (error) {
     rej(error);
   };
  });
}
function addMessage(side, message, image) {
  let inn = image ? '<img class="image-message" src="' + message + '"/>' : linkify(message);
  if(image){
    inn = '<img class="image-message" src="' + message + '"/>';
  }
  messages.innerHTML +=
    '<div class="chat-message is-' +
    side +
    '">' +
    '<div class="chat-message__content">' +
    '<div class="chat-message__bubble-wrapper">' +
    '<div class="chat-message__bubble chat-bubble chat-bubble--' +
    side +
    ' js-message-bubble js-open-chat">' +
    '<div class="chat-bubble__inner">' +
    '<div class="chat-bubble__message">' +
    '<span class="chat-bubble__message-text parsed-text parsed-text--message parsed-text' +
    (side == "client" ? "--dark-bg" : "--very-light-bg") +
    '">' +
    inn +
    "</span>" +
    "</div>" +
    "</div>" +
    "</div>" +
    "</div>" +
    "</div>" +
    "</div>";
}

function sendMessage() {
  var message = input.value.replace(/\s+/g, " ").trim();
  if (message.length < 1) return;
  addMessage("client", message);
  axios.post("/api/support/sendMessage", {
    supportToken: INFO.supportToken,
    message,
  });

  document.querySelector(".chat-scroller").scrollTop =
    document.querySelector(".chat-scroller").scrollHeight;
  input.value = "";
}

function playAudio(){
    const audio = new Audio();
    audio.src = "/audio/new_message.mp3";
    audio.autoplay = true;
    audio.play();
    audio.onended = function (){
        audio.pause();
        delete audio;
    }
}

function updateMessages(without_sound=false) {
  axios
    .post("/api/support/getMessages1", {
      supportToken: INFO.supportToken,
    })
    .then((response) => {
      // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ messageFrom Ğ² Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
      const normalizedMessages = response.data.messages.map(m => ({
        ...m,
        messageFrom: parseInt(m.messageFrom, 10)
      }));

      var have_new_messages = normalizedMessages.filter(a => !lastMessages.find(b => b.id === a.id));
  
      lastMessages = normalizedMessages;
      
      if (have_new_messages.length < 1) return;

      // Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
      console.log('ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹:', normalizedMessages.length);
      console.log('ğŸ†• ĞĞ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹:', have_new_messages.length);
      if (have_new_messages.length > 0) {
        console.log('ĞĞ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:', have_new_messages.map(m => ({
          id: m.id,
          from: m.messageFrom === 1 ? 'ĞºĞ»Ğ¸ĞµĞ½Ñ‚' : 'Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€',
          message: m.message ? m.message.substring(0, 50) : '[Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ]'
        })));
      }

      // Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ·Ğ²ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ° (messageFrom === 0)
      if ( !without_sound ) {
        have_new_messages.forEach(v => {
          if (v.messageFrom === 0) {
            console.log('ğŸ”” Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ğ·Ğ²ÑƒĞºĞ° Ğ´Ğ»Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°');
            playAudio();
          }
        });
      }
      
      messages.innerHTML = "";
      normalizedMessages.forEach((v) => {
        const side = v.messageFrom === 1 ? "client" : "operator";
        if(v.image) {
          addMessage(side, v.image, true);
        } else {
          addMessage(side, v.message);
        }
      });

      window.parent.document.querySelector("#chatra").style.display = "block";
      window.parent.document.querySelector(".support-circle").style.display = "none";

      
      document.querySelector(".chat-scroller").scrollTop =
        document.querySelector(".chat-scroller").scrollHeight;
      
    }).catch(err => {
      console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹:', err);
      return err;
    }).finally(() => setTimeout(updateMessages, 1500))
}

updateMessages(true);
document.documentElement.style.cssText="filter:hue-rotate(1.48deg)";
